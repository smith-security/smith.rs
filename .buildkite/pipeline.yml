steps:
  - label: smith-cli-docker-musl
    plugins:
      - docker#v1.1.1:
          image: smithsecuritydev/ci.rust-1.35.musl:latest
          environment:
            - "BUILDKITE_BRANCH"
            - "BUILDKITE_BUILD_NUMBER"

    command:
      - './bin/publish-musl'

  - label: smith.rs
    plugins:
      - docker#v1.1.1:
          image: smithsecuritydev/ci.rust-1.35:latest
    command:
      - './bin/ci'

  - wait

  - label: smith-cli-docker
    branches: master
    plugins:
      - docker#v1.1.1:
          image: smithsecuritydev/ci.rust-1.35:latest
          environment:
            - "BUILDKITE_BRANCH"
            - "BUILDKITE_BUILD_NUMBER"
      - artifacts#v1.2.0:
          upload: "publish/*"
    command:
      - './bin/publish'

  - wait

  - label: smith-cli-docker
    branches: master
    plugins:
      - artifacts#v1.2.0:
          download: "publish/*"
    command:
      - './bin/push'
